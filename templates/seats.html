{% extends "base.html" %}

{% block title %}Chọn ghế - {{ showtime.movie.title }}{% endblock %}

{% block content %}
<div class="container py-5 mt-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="bg-white p-4 rounded-4 shadow-sm border">
                <div class="screen-container text-center mb-5">
                    <div class="screen-curve"></div>
                    <span class="text-muted small tracking-widest">MÀN HÌNH / SCREEN</span>
                </div>

                <div class="seat-map-wrapper overflow-auto pb-4">
                    <div class="seat-map d-flex flex-column align-items-center" style="min-width: 600px;">
                        {% for row, seats in seats_by_row.items() %}
                        <div class="seat-row d-flex align-items-center mb-2">
                            <span class="row-label me-3 fw-bold text-secondary">{{ row }}</span>
                            
                            {% for seat in seats %}
                                <div class="seat {{ seat.type }} {{ seat.status }} {% if seat.is_aisle %}me-4{% else %}me-1{% endif %}" 
                                     data-code="{{ seat.code }}" 
                                     data-price="{{ showtime.price + (20000 if seat.type == 'vip' else 0) }}"
                                     title="Ghế {{ seat.code }}">
                                </div>
                            {% endfor %}
                            
                            <span class="row-label ms-3 fw-bold text-secondary">{{ row }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="legend d-flex flex-wrap justify-content-center mt-5 gap-4 border-top pt-4">
                    <div class="d-flex align-items-center"><div class="seat normal available me-2"></div> Ghế thường</div>
                    <div class="d-flex align-items-center"><div class="seat vip available me-2"></div> Ghế VIP</div>
                    <div class="d-flex align-items-center"><div class="seat selected me-2"></div> Đang chọn</div>
                    <div class="d-flex align-items-center"><div class="seat occupied me-2"></div> Đã bán</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-lg rounded-4 border-0 p-4 sticky-top" style="top: 100px;">
                <h4 class="fw-bold mb-4 text-danger border-bottom pb-2 text-uppercase">Thông tin đặt vé</h4>
                
                <div class="booking-summary mb-4">
                    <h5 class="fw-bold text-dark mb-1">{{ showtime.movie.title }}</h5>
                    <p class="text-muted mb-1"><i class="fas fa-map-marker-alt me-2"></i>{{ showtime.theater }}</p>
                    <p class="text-muted mb-0"><i class="far fa-clock me-2"></i>{{ showtime.show_time.strftime('%H:%M') }} | {{ showtime.show_date.strftime('%d/%m/%Y') }}</p>
                </div>

                <div class="price-details bg-light p-3 rounded-3 mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ghế:</span>
                        <span id="lbl-seats" class="fw-bold text-dark text-end" style="max-width: 150px;">-</span>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-2">
                        <span class="fs-5 fw-bold">Tổng tiền:</span>
                        <span class="fs-5 fw-bold text-danger"><span id="lbl-total">0</span> VNĐ</span>
                    </div>
                </div>

                <form action="{{ url_for('book_tickets') }}" method="POST">
                    <input type="hidden" name="showtime_id" value="{{ showtime.id }}">
                    <input type="hidden" name="seat_numbers" id="input-seats">
                    <button type="submit" id="btn-book" class="btn btn-danger w-100 py-3 fw-bold rounded-pill shadow" disabled>
                        XÁC NHẬN ĐẶT VÉ
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</style>

<div class="container main-content-wrapper mb-5">
    </div>
<style>
    /* Màn hình cong */
    .screen-curve {
        height: 12px;
        width: 80%;
        background: #03204c;
        margin: 0 auto 10px;
        border-radius: 50% / 100% 100% 0 0;
        box-shadow: 0 10px 15px rgba(3, 32, 76, 0.2);
    }
    .tracking-widest { letter-spacing: 0.3em; }

    /* Thiết kế ghế */
    .seat {
        width: 28px;
        height: 26px;
        border-radius: 4px 4px 10px 10px;
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid #ced4da;
    }
    .seat.available.normal { background: #fff; }
    .seat.available.vip { background: #fff3cd; border-color: #ffc107; }
    
    /* Ghế đang chọn màu đỏ chuẩn thương hiệu */
    .seat.selected { 
        background: #e71a0f !important; 
        border-color: #e71a0f; 
        transform: scale(1.15);
        box-shadow: 0 0 8px rgba(231, 26, 15, 0.5);
    }
    
    .seat.occupied { 
        background: #bbbbbb; 
        cursor: not-allowed; 
        border-color: #999;
    }
    
    .seat:hover:not(.occupied) { 
        border-color: #e71a0f;
    }

    .row-label { width: 25px; font-size: 0.85rem; }
    .btn-danger { background-color: #e71a0f; border: none; }
</style>

<script>
    let selectedSeats = [];
    let totalPrice = 0;

    document.querySelectorAll('.seat.available').forEach(seat => {
        seat.addEventListener('click', () => {
            const seatCode = seat.getAttribute('data-code');
            const seatPrice = parseInt(seat.getAttribute('data-price'));

            if (seat.classList.contains('selected')) {
                seat.classList.remove('selected');
                selectedSeats = selectedSeats.filter(s => s !== seatCode);
                totalPrice -= seatPrice;
            } else {
                seat.classList.add('selected');
                selectedSeats.push(seatCode);
                totalPrice += seatPrice;
            }

            // Cập nhật giao diện thanh toán
            document.getElementById('lbl-seats').innerText = selectedSeats.length > 0 ? selectedSeats.sort().join(', ') : '-';
            document.getElementById('lbl-total').innerText = totalPrice.toLocaleString('vi-VN');
            document.getElementById('input-seats').value = selectedSeats.join(',');
            document.getElementById('btn-book').disabled = selectedSeats.length === 0;
        });
    });
</script>
{% endblock %}